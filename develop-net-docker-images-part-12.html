
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://rasor.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://rasor.github.io/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://rasor.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://rasor.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://rasor.github.io/theme/font-awesome/css/solid.css">

    <link href="https://rasor.github.io/static/custom.css" rel="stylesheet">

    <link href="https://rasor.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Rasor's Tech Blog Atom">


    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">



<meta name="author" content="rasor" />
<meta name="description" content="This blog is part of a serie: Part 0.1: Install Docker Desktop on Windows 10 Home - including WSL Part 0.2: Install k8s using kind on Windows - including arkade Part 1.1: Run docker containers Part 1.2: Develop .NET docker images (this blog) Part 1.3: Run containers …" />
<meta name="keywords" content="#docker, #csharp, #netcore">


<meta property="og:site_name" content="Rasor's Tech Blog"/>
<meta property="og:title" content="Develop .NET docker images - Part 1.2"/>
<meta property="og:description" content="This blog is part of a serie: Part 0.1: Install Docker Desktop on Windows 10 Home - including WSL Part 0.2: Install k8s using kind on Windows - including arkade Part 1.1: Run docker containers Part 1.2: Develop .NET docker images (this blog) Part 1.3: Run containers …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://rasor.github.io/develop-net-docker-images-part-12.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2020-10-25 00:00:00+02:00"/>
<meta property="article:modified_time" content="2020-12-20 17:00:00+01:00"/>
<meta property="article:author" content="https://rasor.github.io/author/rasor.html">
<meta property="article:section" content="Develop"/>
<meta property="article:tag" content="#docker"/>
<meta property="article:tag" content="#csharp"/>
<meta property="article:tag" content="#netcore"/>
<meta property="og:image" content="//s.gravatar.com/avatar/5b6cf6c4e0fa216452dccc8158bf673f?s=120">

  <title>Rasor's Tech Blog &ndash; Develop .NET docker images - Part 1.2</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://rasor.github.io">
        <img src="//s.gravatar.com/avatar/5b6cf6c4e0fa216452dccc8158bf673f?s=120" alt="Rasor's Tech Blog" title="Rasor's Tech Blog">
      </a>
      <h1><a href="https://rasor.github.io">Rasor's Tech Blog</a></h1>

<p>... still playing with this Lego</p>
      <nav>
        <ul class="list">


            <li><a target="_blank" href="https://stackoverflow.com/users/750989/rasor" >StackOverflow</a></li>
            <li><a target="_blank" href="https://www.npmjs.com/~rasor" >npm</a></li>
            <li><a target="_blank" href="https://dock.io?r=sorenraarup:aaaaCSAu" >dock.io</a></li>
            <li><a target="_blank" href="https://keybase.io/rasor" >Keybase</a></li>
            <li><a target="_blank" href="https://stackoverflow.com/cv/rasor" >-- CV --</a></li>
            <li><a target="_blank" href="https://angel.co/rasor" >AngelList</a></li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-twitter" href="https://twitter.com/rasor" target="_blank">
            <i class="fab fa-twitter">
            </i>
          </a></li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/rasor" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-wordpress" href="https://rasor.wordpress.com" target="_blank">
            <i class="fab fa-wordpress">
            </i>
          </a></li>
          <li>
            <a  class="sc-github" href="https://github.com/rasor" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-bitbucket" href="https://bitbucket.org/rasor" target="_blank">
            <i class="fab fa-bitbucket">
            </i>
          </a></li>
          <li>
            <a  class="sc-rss" href="/feeds/all.atom.xml" target="_blank">
            <i class="fas fa-rss">
            </i>
          </a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://rasor.github.io">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>
      <a href="/sitemap.xml">Sitemap</a>

      <a href="https://rasor.github.io/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="develop-net-docker-images-part-12">Develop .NET docker images - Part 1.2</h1>
    <p>
          Posted on October 25, 2020 in <a href="https://rasor.github.io/category/develop.html">Develop</a>

      </br>
        Updated: December 20, 2020
    </p>
  </header>


  <div>
    <p>This blog is part of a serie:</p>
<ul>
<li><a href="https://rasor.github.io/docker-desktop-for-windows-on-wsl2-part-01.html">Part 0.1: Install Docker Desktop on Windows 10 Home - including WSL</a></li>
<li><a href="https://rasor.github.io/k8s-on-windows-devbox-part-02.html">Part 0.2: Install k8s using kind on Windows - including arkade</a></li>
<li><a href="https://rasor.github.io/run-docker-containers-part-11.html">Part 1.1: Run docker containers</a></li>
<li><a href="https://rasor.github.io/develop-net-docker-images-part-12.html">Part 1.2: Develop .NET docker images</a> (this blog)</li>
<li><a href="https://rasor.github.io/aspnet-core-with-k8s-hosting-part-13.html">Part 1.3: Run containers in k8s</a></li>
<li><a href="https://rasor.github.io/k3s-hosted-in-civo-part-20.html">Part 2.0: Deploy containers to Civo</a></li>
</ul>
<h1>Intro</h1>
<p>This blog is an example of a development cycle developing in C# on Windows using VSCode editor - also for debugging docker containers - and deploying to k8s.  </p>
<p>This blog is inspired by content from an eBook and some tutorials.<br>
You find its code in this git repo: <a href="https://github.com/rasor/eBook-UsingNETCoreDockerKubernetes">rasor/eBook-UsingNETCoreDockerKubernetes</a>.  </p>
<p>Main Sources are:</p>
<ul>
<li>Free eBook (2019): <a href="https://www.syncfusion.com/ebooks/using-netcore-docker-and-kubernetes-succinctly">Syncfusion Free Ebooks | Using .NET Core, Docker, and Kubernetes Succinctly</a><ul>
<li>By <a href="https://twitter.com/apomic80">@apomic80</a>        <ul>
<li>Github: <a href="https://github.com/apomic80">apomic80</a></li>
</ul>
</li>
</ul>
</li>
<li>Guide: <a href="https://docs.microsoft.com/en-us/dotnet/architecture/containerized-lifecycle/design-develop-containerized-apps/docker-apps-inner-loop-workflow">Inner-loop development workflow for Docker apps</a><ul>
<li>from free eBook (2020): <a href="https://docs.microsoft.com/en-us/dotnet/architecture/containerized-lifecycle/">Containerized Docker Application Lifecycle with Microsoft Platform and Tools</a> from Microsoft</li>
</ul>
</li>
</ul>
<h1>PreRequisites</h1>
<ul>
<li>Windows 10</li>
<li><a href="https://dotnet.microsoft.com/download">.NET Core 3.1 SDK</a></li>
<li><a href="https://gitforwindows.org/">Git Bash</a></li>
<li><a href="https://code.visualstudio.com/download">Visual Studio Code</a><ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=ms-dotnettools.csharp">C# for VSCode</a></li>
</ul>
</li>
<li><a href="https://docs.docker.com/docker-for-windows/">Docker Desktop for Windows user manual</a></li>
<li><code>k8s</code> (I am using <code>kind</code> for <a href="K8sArkade.md">creating cluster</a>)</li>
<li>Optional: <a href="https://chocolatey.org/install">choco</a></li>
<li>Optional: <a href="https://stedolan.github.io/jq/download/">jq</a></li>
<li>Optional: <a href="https://helm.sh/">helm</a><ul>
<li><code>choco install kubernetes-helm</code> or <code>arkade get helm</code></li>
</ul>
</li>
<li>Optional: <a href="https://github.com/Azure/draft/blob/master/docs/quickstart.md">draft</a></li>
</ul>
<h1>Chapters from eBook <strong>Using .NET Core, Docker, and Kubernetes</strong></h1>
<h2>Chapter 1 ASP.NET and Docker Together</h2>
<h3>Chapter 1.1 Execute .NET Core application with Docker</h3>
<p>See <a href="https://rasor.github.io/run-docker-containers-part-11.html">Part 1.1: Run docker containers</a></p>
<h2>Chapter 2 Create Your Application with Docker</h2>
<h3>Chapter 2.1 Develop your ASP.NET Core application using Docker</h3>
<p>Dotnet core commands:</p>
<ul>
<li>dotnet new: Creates a new project from the specified template. If you want to create an MVC application, you can use dotnet new mvc.</li>
<li>dotnet restore: Restores all the NuGet dependencies of our application.</li>
<li>dotnet build: Builds our project.</li>
<li>dotnet run: Executes our project.</li>
<li>dotnet watch run: Runs our project and watches for file changes to rebuild and re-run it.</li>
<li>dotnet publish: Creates a deployable build (the .dll) of our project.</li>
</ul>
<p>Install VSCode plugin <a href="https://marketplace.visualstudio.com/items?itemName=ms-azuretools.vscode-docker">Docker</a></p>
<div class="highlight"><pre><span></span><span class="c1"># Terminal 1:</span>
<span class="c1"># Create a C# gitignore file in the root</span>
dotnet new gitignore

<span class="c1"># create a folder for MVC frontend</span>
mkdir -p cpt2/frontend
<span class="nb">cd</span> cpt2/frontend
<span class="c1"># Create mvc web</span>
dotnet new mvc

<span class="c1"># Build an run a webserver</span>
dotnet build
dotnet run
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Terminal 2:</span>
<span class="c1"># open a browser</span>
start https://localhost:5001/
</pre></div>


<p>Stop the webserver in Teminal 1 with ctrl-c.  </p>
<p>Now create <code>.vscode</code> files <code>launch.json</code> and <code>tasks.json</code>:  </p>
<ul>
<li>Ctrl-shft-p # to open cmd palette</li>
<li><code>.NET: Generate Assets for Build and Debug</code><ul>
<li>Choose <code>ASPNET Core</code>, <code>linux</code> container and ports <code>5000, 5001</code></li>
</ul>
</li>
</ul>
<p>You can now goto <strong>RUN</strong> pane with <code>ctrl-shft-d</code>, select the <code>.NET Core Launch (web)</code> config and press run.  <br>
In the Debug console you will see</p>
<div class="highlight"><pre><span></span><span class="c1"># Debug console</span>
<span class="c1"># Using launch settings from &#39;C:\Users\zzz\eBook-UsingNETCoreDockerKubernetes/cpt2/frontend\Properties\launchSettings.json&#39; [Profile &#39;frontend&#39;]...</span>
<span class="c1"># Loaded &#39;C:\Users\zzz\eBook-UsingNETCoreDockerKubernetes\cpt2\frontend\bin\Debug\netcoreapp3.1\frontend.dll&#39;. Symbols loaded.</span>
<span class="c1"># .....</span>
</pre></div>


<p>You can hit breakpoints.  </p>
<p>Now create a <code>Dockerfile</code>, <code>.dockerignore</code> and <code>docker-compose.yml</code>:  </p>
<ul>
<li>In explorer put cursor on cpt2\frontend</li>
<li>Ctrl-shft-p # to open cmd palette</li>
<li><code>Docker: Add Docker files to workspace</code><ul>
<li>Choose <code>ASPNET Core</code>, <code>linux</code> container and ports <code>5000, 5001</code>, <code>yes</code> to create compose file
<img alt="Add Dockerfile" src="https://docs.microsoft.com/en-us/dotnet/architecture/containerized-lifecycle/design-develop-containerized-apps/media/docker-apps-inner-loop-workflow/add-docker-files-to-workspace-command.png"><br>
<em>(Img from Microsoft) Add Dockerfile in VSCode</em></li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="c"># Generated Dockerfile</span>
<span class="c"># 1. Target img to deploy to</span>
<span class="k">FROM</span> <span class="s">mcr.microsoft.com/dotnet/core/aspnet:3.1</span> <span class="k">AS</span> <span class="s">base</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="k">EXPOSE</span><span class="s"> 5000</span>
<span class="k">EXPOSE</span><span class="s"> 5001</span>

<span class="c"># 5. Source img to build on</span>
<span class="k">FROM</span> <span class="s">mcr.microsoft.com/dotnet/core/sdk:3.1</span> <span class="k">AS</span> <span class="s">build</span>
<span class="k">WORKDIR</span><span class="s"> /src</span>
<span class="c"># 7. Copy project file from local pc into Source img</span>
<span class="k">COPY</span> <span class="o">[</span><span class="s2">&quot;cpt2/frontend/frontend.csproj&quot;</span>, <span class="s2">&quot;cpt2/frontend/&quot;</span><span class="o">]</span>
<span class="k">RUN</span> dotnet restore <span class="s2">&quot;cpt2/frontend/frontend.csproj&quot;</span>
<span class="k">COPY</span> . .
<span class="k">WORKDIR</span><span class="s"> &quot;/src/cpt2/frontend&quot;</span>
<span class="c"># 11. Build .dll</span>
<span class="k">RUN</span> dotnet build <span class="s2">&quot;frontend.csproj&quot;</span> -c Release -o /app/build

<span class="k">FROM</span> <span class="s">build</span> <span class="k">AS</span> <span class="s">publish</span>
<span class="c"># 13. Create a deployable package</span>
<span class="k">RUN</span> dotnet publish <span class="s2">&quot;frontend.csproj&quot;</span> -c Release -o /app/publish

<span class="k">FROM</span> <span class="s">base</span> <span class="k">AS</span> <span class="s">final</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="c"># 16. Copy from Source img to Target img</span>
<span class="k">COPY</span> --from<span class="o">=</span>publish /app/publish .
<span class="c"># 17. Define start command</span>
<span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;dotnet&quot;</span><span class="p">,</span> <span class="s2">&quot;frontend.dll&quot;</span><span class="p">]</span>
</pre></div>


<p>Change cmd 7 to 10, so you'll be able to <code>docker build</code> from inside folder <code>cpt2/frontend</code></p>
<div class="highlight"><pre><span></span><span class="c"># 7. Copy project file from local pc into Source img</span>
<span class="k">COPY</span> ./frontend.csproj .
<span class="k">RUN</span> dotnet restore frontend.csproj
<span class="k">COPY</span> . .
<span class="k">WORKDIR</span><span class="s"> /src</span>
</pre></div>


<ul>
<li><a href="https://docs.docker.com/engine/reference/builder/">Dockerfile reference</a></li>
</ul>
<p>Let's build our docker img</p>
<div class="highlight"><pre><span></span><span class="c1"># verify docker is running</span>
docker images
<span class="c1"># goto folder with Dockerfile</span>
<span class="nb">cd</span> cpt2/frontend
docker build --help
<span class="c1"># build img and tag it frontend2</span>
docker build -t frontend2 .

<span class="c1"># System.InvalidOperationException: Unable to configure HTTPS endpoint. No server certificate was specified, and the default developer certificate could not be found or is out of date.</span>


<span class="c1"># Sending build context to Docker daemon  6.432MB</span>
<span class="c1"># Step 1/17 : FROM mcr.microsoft.com/dotnet/core/aspnet:3.1 AS base</span>
<span class="c1"># 3.1: Pulling from dotnet/core/aspnet</span>
<span class="c1"># bb79b6b2107f: Pull complete</span>
<span class="c1"># fd6f53cfcb35: Pull complete</span>
<span class="c1"># 29b35ed07a14: Pull complete</span>
<span class="c1"># fd068c4127c7: Pull complete</span>
<span class="c1"># dc51486f316e: Pull complete</span>
<span class="c1"># Digest: sha256:4030ec40f9b5c1e8cac5d550639b7b05d1d6af0c89b4b47d66bad7f93379c9eb</span>
<span class="c1"># Status: Downloaded newer image for mcr.microsoft.com/dotnet/core/aspnet:3.1</span>
<span class="c1">#  ---&gt; e3559b2d50bb</span>
<span class="c1"># Step 2/17 : WORKDIR /app</span>
<span class="c1">#  ---&gt; Running in 14fd02991c3d</span>
<span class="c1"># Removing intermediate container 14fd02991c3d</span>
<span class="c1">#  ---&gt; df46b5f3b46a</span>
<span class="c1"># Step 3/17 : EXPOSE 5000</span>
<span class="c1">#  ---&gt; Running in 5adf5a71198d</span>
<span class="c1"># Removing intermediate container 5adf5a71198d</span>
<span class="c1">#  ---&gt; 817df2c51839</span>
<span class="c1"># Step 4/17 : EXPOSE 5001</span>
<span class="c1">#  ---&gt; Running in 1815541a6c6a</span>
<span class="c1"># Removing intermediate container 1815541a6c6a</span>
<span class="c1">#  ---&gt; 02891abd8059</span>
<span class="c1"># Step 5/17 : FROM mcr.microsoft.com/dotnet/core/sdk:3.1 AS build</span>
<span class="c1"># 3.1: Pulling from dotnet/core/sdk</span>
<span class="c1"># e4c3d3e4f7b0: Pull complete</span>
<span class="c1"># 101c41d0463b: Pull complete</span>
<span class="c1"># 8275efcd805f: Pull complete</span>
<span class="c1"># 751620502a7a: Pull complete</span>
<span class="c1"># 8e306865fd07: Pull complete</span>
<span class="c1"># 9d2f53e752c2: Pull complete</span>
<span class="c1"># 143a93e01eba: Pull complete</span>
<span class="c1"># Digest: sha256:d09eefeaad2129f0a0ac047095792afc6792e7aae4b8bb1c1fa5b6650caae240</span>
<span class="c1"># Status: Downloaded newer image for mcr.microsoft.com/dotnet/core/sdk:3.1</span>
<span class="c1">#  ---&gt; 5fe503d51830</span>
<span class="c1"># Step 6/17 : WORKDIR /src</span>
<span class="c1">#  ---&gt; Running in 143a136929b6</span>
<span class="c1"># Removing intermediate container 143a136929b6</span>
<span class="c1">#  ---&gt; 0e5a8185b7a2</span>
<span class="c1"># Step 7/17 : COPY ./frontend.csproj .</span>
<span class="c1">#  ---&gt; 203c96e3d357</span>
<span class="c1"># Step 8/17 : RUN dotnet restore frontend.csproj</span>
<span class="c1">#  ---&gt; Running in cd917bface5b</span>
<span class="c1">#   Determining projects to restore...</span>
<span class="c1">#   Restored /src/frontend.csproj (in 170 ms).</span>
<span class="c1"># Removing intermediate container cd917bface5b</span>
<span class="c1">#  ---&gt; 866543516985</span>
<span class="c1"># Step 9/17 : COPY . .</span>
<span class="c1">#  ---&gt; 6ac6636b092c</span>
<span class="c1"># Step 10/17 : WORKDIR /src</span>
<span class="c1">#  ---&gt; Running in 40c27a3098f1</span>
<span class="c1"># Removing intermediate container 40c27a3098f1</span>
<span class="c1">#  ---&gt; d3f07b018611</span>
<span class="c1"># Step 11/17 : RUN dotnet build &quot;frontend.csproj&quot; -c Release -o /app/build</span>
<span class="c1">#  ---&gt; Running in 56cc1964bf83</span>
<span class="c1"># Microsoft (R) Build Engine version 16.7.0+7fb82e5b2 for .NET</span>
<span class="c1"># Copyright (C) Microsoft Corporation. All rights reserved.</span>
<span class="c1">#   Determining projects to restore...</span>
<span class="c1">#   Restored /src/frontend.csproj (in 185 ms).</span>
<span class="c1">#   frontend -&gt; /app/build/frontend.dll</span>
<span class="c1">#   frontend -&gt; /app/build/frontend.Views.dll</span>
<span class="c1"># Build succeeded.</span>
<span class="c1">#     0 Warning(s)</span>
<span class="c1">#     0 Error(s)</span>
<span class="c1"># Time Elapsed 00:00:05.03</span>
<span class="c1"># Removing intermediate container 56cc1964bf83</span>
<span class="c1">#  ---&gt; 7ccf08805a5b</span>
<span class="c1"># Step 12/17 : FROM build AS publish</span>
<span class="c1">#  ---&gt; 7ccf08805a5b</span>
<span class="c1"># Step 13/17 : RUN dotnet publish &quot;frontend.csproj&quot; -c Release -o /app/publish</span>
<span class="c1">#  ---&gt; Running in 27507652111d</span>
<span class="c1"># Microsoft (R) Build Engine version 16.7.0+7fb82e5b2 for .NET</span>
<span class="c1"># Copyright (C) Microsoft Corporation. All rights reserved.</span>
<span class="c1">#   Determining projects to restore...</span>
<span class="c1">#   All projects are up-to-date for restore.</span>
<span class="c1">#   frontend -&gt; /src/bin/Release/netcoreapp3.1/frontend.dll</span>
<span class="c1">#   frontend -&gt; /src/bin/Release/netcoreapp3.1/frontend.Views.dll</span>
<span class="c1">#   frontend -&gt; /app/publish/</span>
<span class="c1"># Removing intermediate container 27507652111d</span>
<span class="c1">#  ---&gt; c08c7122d789</span>
<span class="c1"># Step 14/17 : FROM base AS final</span>
<span class="c1">#  ---&gt; 02891abd8059</span>
<span class="c1"># Step 15/17 : WORKDIR /app</span>
<span class="c1">#  ---&gt; Running in b52e89be9e92</span>
<span class="c1"># Removing intermediate container b52e89be9e92</span>
<span class="c1">#  ---&gt; 97d3ac799145</span>
<span class="c1"># Step 16/17 : COPY --from=publish /app/publish .</span>
<span class="c1">#  ---&gt; 2ac048ea1f90</span>
<span class="c1"># Step 17/17 : ENTRYPOINT [&quot;dotnet&quot;, &quot;frontend.dll&quot;]</span>
<span class="c1">#  ---&gt; Running in 7359a524012b</span>
<span class="c1"># Removing intermediate container 7359a524012b</span>
<span class="c1">#  ---&gt; f7828ef4f47e</span>
<span class="c1"># Successfully built f7828ef4f47e</span>
<span class="c1"># Successfully tagged frontend2:latest</span>
<span class="c1"># SECURITY WARNING: You are building a Docker image from Windows against a non-Windows Docker host. All files and directories added to build context will have </span>
<span class="c1"># &#39;-rwxr-xr-x&#39; permissions. It is recommended to double check and reset permissions for sensitive files and directories.</span>

<span class="c1"># Print image</span>
docker images
<span class="c1"># REPOSITORY                             TAG                 IMAGE ID            CREATED             SIZE  </span>
<span class="c1"># frontend2                              latest              f7828ef4f47e        5 minutes ago       212MB </span>
<span class="c1"># mcr.microsoft.com/dotnet/core/aspnet   3.1                 e3559b2d50bb        7 days ago          207MB </span>
<span class="c1"># mcr.microsoft.com/dotnet/core/sdk      3.1                 5fe503d51830        7 days ago          708MB </span>

<span class="c1"># Test run the img</span>
docker run -p <span class="m">5000</span>:5000 --name nfrontend2 -t frontend2 -e <span class="s2">&quot;ASPNETCORE_URLS=http://+:5000&quot;</span>
<span class="c1">#docker run -p 5000:5000 -p 5001:5001 --name nfrontend2 -t frontend2</span>
<span class="c1">#docker create -p 5000:5000 -p 5001:5001 --name nfrontend2 -t frontend2 --entrypoint &#39;dotnet dev-certs https &amp;&amp; # warn: Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository[60]</span>
<span class="c1">#       Storing keys in a directory &#39;/root/.aspnet/DataProtection-Keys&#39; that may not be persisted outside of the container. Protected data will be unavailable </span>
<span class="c1"># when container is destroyed.</span>
<span class="c1">#       No XML encryptor configured. Key {22010cbd-95fa-4543-9ae3-63ee61afff7f} may be persisted to storage in unencrypted form.</span>
<span class="c1">#       Now listening on: http://[::]:80</span>
<span class="c1">#       Application started. Press Ctrl+C to shut down.</span>
<span class="c1">#       Hosting environment: Production</span>
<span class="c1">#       Content root path: /app</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Terminal 2:</span>
docker start nfrontend2
<span class="c1"># Which containers are running?</span>
docker ps
<span class="c1"># CONTAINER ID        IMAGE               COMMAND                 CREATED             STATUS              PORTS                              NAMES</span>
<span class="c1"># 6fc16e63dbd5        frontend2           &quot;dotnet frontend.dll&quot;   18 seconds ago      Up 17 seconds       0.0.0.0:5000-5001-&gt;5000-5001/tcp   nfrontend2   </span>

<span class="c1"># Print entry point</span>
docker ps -a --format <span class="s2">&quot;table {{.Image}}:\t {{.Command}}&quot;</span> --no-trunc
<span class="c1"># IMAGE:                   COMMAND</span>
<span class="c1"># frontend2:               &quot;dotnet frontend.dll…&quot;</span>

<span class="c1"># Print as json</span>
docker ps -a --format <span class="s2">&quot; {{json .}}&quot;</span> <span class="p">|</span> jq <span class="s1">&#39;{ID, Image, Command}&#39;</span>

<span class="c1"># Open browser</span>
start http://localhost:5000

<span class="c1"># Cleanup</span>
docker stop nfrontend2
docker rm nfrontend2
<span class="c1"># Cleanup done?</span>
docker ps -a
</pre></div>


<h3>Chapter 2.1B (not in eBook) Debug your docker container</h3>
<p>To be able to debug on port 5000 you need to do a change in the launcsetting:</p>
<p>Before:</p>
<div class="highlight"><pre><span></span><span class="err">// .vscode/tasks.json</span>
<span class="err">                        &quot;label&quot;: &quot;docker-run: debug&quot;,</span>
<span class="err">                        &quot;dependsOn&quot;: [</span>
<span class="err">                                &quot;docker-build: debug&quot;</span>
<span class="err">                        ],</span>
<span class="err">                        &quot;dockerRun&quot;: {},</span>
</pre></div>


<p>After:</p>
<div class="highlight"><pre><span></span><span class="err">// .vscode/tasks.json</span>
<span class="err">                        &quot;label&quot;: &quot;docker-run: debug&quot;,</span>
<span class="err">                        &quot;dependsOn&quot;: [</span>
<span class="err">                                &quot;docker-build: debug&quot;</span>
<span class="err">                        ],</span>
<span class="err">                        &quot;dockerRun&quot;: {</span>
<span class="err">                                &quot;env&quot;: {</span>
<span class="err">                                        &quot;ASPNETCORE_URLS&quot;: &quot;https://+:5001;http://+:5000&quot;</span>
<span class="err">                                },</span>
<span class="err">                                &quot;ports&quot;: [</span>
<span class="err">                                        { &quot;hostPort&quot;: 5000, &quot;containerPort&quot;: 5000 },</span>
<span class="err">                                        { &quot;hostPort&quot;: 5001, &quot;containerPort&quot;: 5001 }</span>
<span class="err">                                ]</span>
<span class="err">                        },</span>
</pre></div>


<p>If you goto <strong>RUN</strong> pane and choose <code>Docker .NET Core Launch</code> in the dropdown and then press the "Play" button then you can place breakpoints in your code and remote debug into your container. VSCode will show this:</p>
<div class="highlight"><pre><span></span><span class="c1">#&gt; Executing task: docker-build: debug &lt;</span>

docker build --rm --pull -f <span class="s2">&quot;C:\Users\zzz\eBook-UsingNETCoreDockerKubernetes/cpt2/frontend/Dockerfile&quot;</span> --label <span class="s2">&quot;com.microsoft.created-by=visual-studio-code&quot;</span> -t <span class="s2">&quot;ebookusingnetcoredockerkubernetes:dev&quot;</span> --target <span class="s2">&quot;base&quot;</span> <span class="s2">&quot;C:\Users\zzz\eBook-UsingNETCoreDockerKubernetes&quot;</span>

<span class="c1"># Where</span>
<span class="c1"># -f, --file string         Name of the Dockerfile (Default is &#39;PATH/Dockerfile&#39;)</span>
<span class="c1"># --label list              Set metadata for an image</span>
<span class="c1"># --pull                    Always attempt to pull a newer version of the image</span>
<span class="c1"># --rm                      Remove intermediate containers after a successful build (default true)</span>
<span class="c1"># -t, --tag list            Name and optionally a tag in the &#39;name:tag&#39; format</span>
<span class="c1"># --target string           Set the target build stage to build.</span>

<span class="c1">#&gt; Executing task: docker-run: debug &lt;</span>

docker run -dt -P --name <span class="s2">&quot;ebookusingnetcoredockerkubernetes-dev&quot;</span> -e <span class="s2">&quot;DOTNET_USE_POLLING_FILE_WATCHER=1&quot;</span> -e <span class="s2">&quot;ASPNETCORE_ENVIRONMENT=Development&quot;</span> -e <span class="s2">&quot;ASPNETCORE_URLS=https://+:5001;http://+:5000&quot;</span> --label <span class="s2">&quot;com.microsoft.created-by=visual-studio-code&quot;</span> -v <span class="s2">&quot;C:\Users\zzz\eBook-UsingNETCoreDockerKubernetes/cpt2/frontend:/app:rw&quot;</span> -v <span class="s2">&quot;c:\Users\zzz\eBook-UsingNETCoreDockerKubernetes:/src:rw&quot;</span> -v <span class="s2">&quot;C:\Users\zzz\.vsdbg:/remote_debugger:ro&quot;</span> -v <span class="s2">&quot;C:\Users\zzz\.nuget\packages:/root/.nuget/packages:ro&quot;</span> -v <span class="s2">&quot;C:\Program Files\dotnet\sdk\NuGetFallbackFolder:/root/.nuget/fallbackpackages:ro&quot;</span> -v <span class="s2">&quot;C:\Users\zzz\AppData\Roaming\Microsoft\UserSecrets:/root/.microsoft/usersecrets:ro&quot;</span> -v <span class="s2">&quot;C:\Users\zzz\AppData\Roaming\ASP.NET\Https:/root/.aspnet/https:ro&quot;</span> -p <span class="s2">&quot;5000:5000&quot;</span> -p <span class="s2">&quot;5001:5001&quot;</span> <span class="s2">&quot;ebookusingnetcoredockerkubernetes:dev&quot;</span>

<span class="c1"># Where</span>
<span class="c1"># -d, --detach                         Run container in background and print container ID</span>
<span class="c1"># -t, --tty                            Allocate a pseudo-TTY</span>
<span class="c1"># -l, --label list                     Set meta data on a container</span>
<span class="c1"># -P, --publish-all                    Publish all exposed ports to random ports</span>
<span class="c1"># -v, --volume list                    Bind mount a volume</span>
<span class="c1"># Some from tasks.json:</span>
<span class="c1"># -e, --env list                       Set environment variables</span>
<span class="c1"># -p, --publish list                   Publish a container&#39;s port(s) to the host</span>
</pre></div>


<p>Isn't that nice?</p>
<ul>
<li>Ref: <a href="https://code.visualstudio.com/docs/containers/debug-common">Debug an app running in a Docker container</a></li>
</ul>
<h3>Chapter 2.2 Add containers to your project</h3>
<p><em>To Be Added</em></p>
<h3>Chapter 2.3 Run your container with Docker Compose</h3>
<p>When you used Command Palette command <code>Docker: Add Docker files to workspace</code> then you said yes to create compose files:</p>
<div class="highlight"><pre><span></span><span class="c1"># Generated docker-compose.debug.yml</span>
<span class="c1"># Please refer https://aka.ms/HTTPSinContainer on how to setup an https developer certificate for your ASP .NET Core service.</span>

<span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.4&#39;</span>

<span class="nt">services</span><span class="p">:</span>
    <span class="nt">frontend</span><span class="p">:</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">frontend</span>
        <span class="nt">build</span><span class="p">:</span>
            <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
            <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cpt2/frontend/Dockerfile</span>
        <span class="nt">ports</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5000</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5001</span>
        <span class="nt">environment</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ASPNETCORE_ENVIRONMENT=Development</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ASPNETCORE_URLS=http://+:5000</span>
        <span class="nt">volumes</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">~/.vsdbg:/remote_debugger:rw</span>
</pre></div>


<p>Change frontend in both the .debug.yml and then non-debug yml to:</p>
<div class="highlight"><pre><span></span>    <span class="nt">frontend</span><span class="p">:</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">frontend2</span>
        <span class="c1"># Add this</span>
        <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">frontend2</span> <span class="c1"># then you can attach to this name</span>
        <span class="nt">build</span><span class="p">:</span>
            <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">./cpt2/frontend</span>
            <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dockerfile</span>
        <span class="nt">environment</span><span class="p">:</span>
        <span class="c1"># Add this to the non-debug</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ASPNETCORE_URLS=https://+:5001;http://+:5000</span>
</pre></div>


<p>So now we can start several containers at once (if more containeres were present in the compose file).<br>
Compose will also create a docker network for the containers to communicate through.  </p>
<div class="highlight"><pre><span></span><span class="c1"># ensure you find the root folder</span>
<span class="nb">cd</span> cpt2/frontend
<span class="c1"># go back to root, where docker-compose.yml exists</span>
<span class="nb">cd</span> ../..

docker-compose up

start http://localhost:5000

<span class="c1"># ctrl-c to stop the servers</span>
<span class="c1"># or</span>
docker-compose stop
<span class="c1"># or</span>
docker-compose down <span class="c1"># will also remove (docker-compose rm)</span>

<span class="c1"># check which containers exists</span>
docker ps -a

<span class="c1"># then restart # if not removed</span>
docker-compose start
</pre></div>


<ul>
<li>Refs: <ul>
<li><a href="https://docs.docker.com/compose/reference/overview/">Overview of docker-compose CLI</a></li>
</ul>
</li>
</ul>
<p>Can we debug code running in a container by attiching our local code to it?</p>
<ul>
<li>Goto the <strong>RUN</strong> pane</li>
<li>In the Run-dropdown - do <code>Àdd Confuguration</code></li>
<li>Choose <code>Docker .NET Core Attach (Preview)</code></li>
</ul>
<p>This will create most of this</p>
<div class="highlight"><pre><span></span><span class="err">//.vscode/launch.json</span>
        <span class="p">{</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Docker .NET Core Attach (Preview)&quot;</span><span class="p">,</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;docker&quot;</span><span class="p">,</span>
                <span class="nt">&quot;request&quot;</span><span class="p">:</span> <span class="s2">&quot;attach&quot;</span><span class="p">,</span>
                <span class="nt">&quot;containerName&quot;</span><span class="p">:</span> <span class="s2">&quot;frontend2&quot;</span><span class="p">,</span>
                <span class="nt">&quot;platform&quot;</span><span class="p">:</span> <span class="s2">&quot;netCore&quot;</span><span class="p">,</span>
                <span class="nt">&quot;sourceFileMap&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nt">&quot;/src&quot;</span><span class="p">:</span> <span class="s2">&quot;${workspaceFolder}&quot;</span>
                <span class="p">},</span>
        <span class="p">}</span><span class="err">,</span>
</pre></div>


<p>Optionally add <code>containerName</code> in or to auto attach to a specific running container.  </p>
<p>Now spin up the container</p>
<div class="highlight"><pre><span></span><span class="c1"># use debug compose file</span>
docker-compose -f docker-compose.debug.yml up
</pre></div>


<p>That will show in a docker terminal:</p>
<div class="highlight"><pre><span></span><span class="c1"># Docker terminal</span>
<span class="c1"># &gt; Executing task: docker-compose -f &quot;docker-compose.debug.yml&quot; up -d --build &lt;</span>

<span class="c1"># Creating network &quot;ebook-usingnetcoredockerkubernetes_default&quot; with the default driver</span>
<span class="c1"># Building frontend</span>
<span class="c1"># Step 1/17 : FROM mcr.microsoft.com/dotnet/core/aspnet:3.1 AS base</span>
<span class="c1">#  ---&gt; e3559b2d50bb</span>
<span class="c1"># ......</span>
<span class="c1"># Step 17/17 : ENTRYPOINT [&quot;dotnet&quot;, &quot;frontend.dll&quot;]</span>
<span class="c1">#  ---&gt; Using cache</span>
<span class="c1">#  ---&gt; 6572076fad45</span>

<span class="c1"># Successfully built 6572076fad45</span>
<span class="c1"># Successfully tagged frontend2:latest</span>
<span class="c1"># Creating frontend2 ... done</span>
</pre></div>


<p>Now in the <strong>RUN</strong> pane select the <code>Docker .NET Core Attach (Preview)</code> config and press run.<br>
In the Debug console you will see</p>
<div class="highlight"><pre><span></span><span class="c1"># Debug console</span>
<span class="c1"># Starting: &quot;docker&quot; exec -i frontend2 /remote_debugger/vsdbg --interpreter=vscode</span>
<span class="c1"># .....</span>
<span class="c1"># Loaded &#39;/app/frontend.dll&#39;. Symbols loaded.</span>
<span class="c1"># .....</span>
</pre></div>


<p>You should be able to set breakpoints in your code and break.<br>
But something is not quite right, yet. It does not work on my PC.  </p>
<ul>
<li>Refs: <ul>
<li><a href="https://code.visualstudio.com/docs/containers/docker-compose">Use Docker Compose to work with multiple containers</a><ul>
<li>Debug NetCore: <a href="https://code.visualstudio.com/docs/containers/docker-compose#_net">NetCore</a></li>
</ul>
</li>
<li><a href="https://code.visualstudio.com/docs/remote/attach-container">Attach to a running container using Visual Studio Code Remote Development</a></li>
</ul>
</li>
</ul>
<h3>Chapter 2.4 Create the final image for publication</h3>
<h4>Publish image to docker hub</h4>
<p>Create a docker hub repo. I'll publish to<br>
https://hub.docker.com/repository/docker/rasor/usingnetcoredockerkubernetes </p>
<div class="highlight"><pre><span></span><span class="c1"># goto folder with Dockerfile</span>
<span class="nb">cd</span> cpt2/frontend
docker build --help
<span class="c1"># build img and tag it</span>
docker build -t frontend2:v1 .
<span class="c1"># Successfully built 6572076fad45</span>
<span class="c1"># Successfully tagged frontend2:v1</span>

docker images <span class="p">|</span> grep frontend2
<span class="c1"># frontend2                              latest              6572076fad45        3 days ago          212MB</span>
<span class="c1"># frontend2                              v1                  6572076fad45        3 days ago          212MB</span>

<span class="c1"># tag the image, so you can upload it to docker hub</span>
<span class="c1"># docker tag local-image:tagname new-repo:tagname</span>
docker tag frontend2:v1 rasor/usingnetcoredockerkubernetes:frontend2-v1

docker images <span class="p">|</span> grep frontend2
<span class="c1"># REPOSITORY                             TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="c1"># rasor/usingnetcoredockerkubernetes     frontend2-v1        6572076fad45        3 days ago          212MB</span>
<span class="c1"># frontend2                              latest              6572076fad45        3 days ago          212MB</span>
<span class="c1"># frontend2                              v1                  6572076fad45        3 days ago          212MB</span>

<span class="c1"># upload docker img to https://hub.docker.com/repository/docker/rasor/usingnetcoredockerkubernetes</span>
<span class="c1"># docker push new-repo:tagname</span>
docker push rasor/usingnetcoredockerkubernetes:frontend2-v1
<span class="c1"># The push refers to repository [docker.io/rasor/usingnetcoredockerkubernetes]</span>
<span class="c1"># ...</span>
<span class="c1"># frontend2-v1: digest: sha256:e413934f1dba2e85b66f69125f6b4ac9944122c8f1c3d8f0f97355abb6ad8ec9 size: 1793</span>

<span class="c1"># When you want to download it do:</span>
<span class="c1"># docker pull rasor/usingnetcoredockerkubernetes:frontend2-v1</span>
</pre></div>


<h2>Chapter 3 Deploy Your Application on Kubernetes</h2>
<h3>Chapter 3.2 Deploy your images in Kubernetes</h3>
<p>See <a href="https://rasor.github.io/aspnet-core-with-k8s-hosting-part-13.html">Part 1.3</a></p>
<p>The End</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://rasor.github.io/tag/docker.html">#docker</a>
      <a href="https://rasor.github.io/tag/csharp.html">#csharp</a>
      <a href="https://rasor.github.io/tag/netcore.html">#netcore</a>
    </p>
  </div>





</article>

    <footer>
<p>
  &copy; rasor 2017 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Rasor's Tech Blog ",
  "url" : "https://rasor.github.io",
  "image": "//s.gravatar.com/avatar/5b6cf6c4e0fa216452dccc8158bf673f?s=120",
  "description": ""
}
</script>

</body>
</html>